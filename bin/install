#!/usr/bin/env bash

set -euo pipefail

die() {
  local message=$1
  echo "$message" >&2
  exit 1
}

platform() {
  local plat
  plat="$(uname -s)"
  if [ "$plat" = "Darwin" ]; then
    echo "$plat"
  elif [ "$plat" = "Linux" ]; then
    echo "$plat"
  else
    die "Unsupported platform '$plat'."
  fi
}

filename() {
  local version=$1

  echo "task-${version}-$(platform).tar.gz"
}

build_and_install_taskwarrior() {
  local download=$1
  local install=$2
  local version=$3

  cd "${download}/tw"
  echo "Building Taskwarrior $version ..."
  cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
  cmake --build build
  make -C build package
  echo "Installing Taskwarrior $version to $install ..."
  tar -xf "${download}/tw/build/$(filename "$version")" -C "$install" --strip-components 1
  echo "Install complete!"
}

build_and_install_taskwarrior "$ASDF_DOWNLOAD_PATH" "$ASDF_INSTALL_PATH" "$ASDF_INSTALL_VERSION"
